<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS 면접 주관식 퀴즈</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 30px 0;
        }

        h1 {
            font-size: 2.2rem;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #888;
            font-size: 1rem;
        }

        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00d2ff;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #aaa;
        }

        .category-section {
            margin: 25px 0;
        }

        .category-section h3 {
            color: #00d2ff;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .category-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .category-checkbox {
            display: none;
        }

        .category-label {
            padding: 8px 16px;
            border: 2px solid #3a7bd5;
            background: transparent;
            color: #aaa;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
            user-select: none;
        }

        .category-label:hover {
            border-color: #00d2ff;
            color: #fff;
        }

        .category-checkbox:checked + .category-label {
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            border-color: transparent;
            color: #fff;
        }

        .select-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .select-btn {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #888;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .select-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .quiz-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            margin-top: 20px;
        }

        .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin-bottom: 25px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            border-radius: 3px;
            transition: width 0.3s;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .question-number {
            font-size: 0.85rem;
            color: #888;
        }

        .question-id {
            font-size: 0.75rem;
            color: #666;
            font-family: monospace;
        }

        .question-category {
            background: rgba(0, 210, 255, 0.2);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            color: #00d2ff;
        }

        .question-text {
            font-size: 1.2rem;
            line-height: 1.6;
            margin-bottom: 25px;
        }

        .answer-section {
            margin-bottom: 20px;
        }

        .answer-textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #fff;
            font-size: 1rem;
            line-height: 1.6;
            resize: vertical;
            font-family: inherit;
        }

        .answer-textarea:focus {
            outline: none;
            border-color: #3a7bd5;
        }

        .answer-textarea::placeholder {
            color: #666;
        }

        .submit-btn {
            padding: 12px 30px;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 210, 255, 0.3);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .feedback-container {
            margin-top: 25px;
            padding: 20px;
            border-radius: 12px;
            display: none;
        }

        .feedback-container.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        .feedback-excellent {
            background: rgba(0, 200, 83, 0.15);
            border-left: 4px solid #00c853;
        }

        .feedback-good {
            background: rgba(0, 210, 255, 0.15);
            border-left: 4px solid #00d2ff;
        }

        .feedback-partial {
            background: rgba(255, 193, 7, 0.15);
            border-left: 4px solid #ffc107;
        }

        .feedback-needs-work {
            background: rgba(255, 82, 82, 0.15);
            border-left: 4px solid #ff5252;
        }

        .feedback-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .feedback-icon {
            font-size: 1.5rem;
        }

        .feedback-score {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .feedback-score.excellent { color: #00c853; }
        .feedback-score.good { color: #00d2ff; }
        .feedback-score.partial { color: #ffc107; }
        .feedback-score.needs-work { color: #ff5252; }

        .similarity-details {
            margin: 15px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .similarity-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            color: #aaa;
        }

        .similarity-item span:last-child {
            color: #00d2ff;
            font-weight: bold;
        }

        .keywords-section {
            margin: 15px 0;
        }

        .keywords-title {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 8px;
        }

        .keywords-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .keyword {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .keyword.matched {
            background: rgba(0, 200, 83, 0.3);
            color: #00c853;
        }

        .keyword.missed {
            background: rgba(255, 82, 82, 0.2);
            color: #ff5252;
        }

        .model-answer {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .model-answer-title {
            font-size: 0.9rem;
            color: #00d2ff;
            margin-bottom: 10px;
        }

        .model-answer-text {
            color: #ccc;
            line-height: 1.7;
            font-size: 0.95rem;
            white-space: pre-wrap;
        }

        .references {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .references-title {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 8px;
        }

        .references a {
            display: block;
            color: #3a7bd5;
            text-decoration: none;
            font-size: 0.85rem;
            margin: 4px 0;
        }

        .references a:hover {
            color: #00d2ff;
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
            gap: 15px;
        }

        .nav-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .nav-btn.prev {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .nav-btn.prev:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .nav-btn.next {
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            color: #fff;
            flex: 1;
            max-width: 180px;
        }

        .nav-btn.next:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 210, 255, 0.3);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .result-container {
            text-align: center;
            padding: 40px 20px;
            display: none;
        }

        .result-container.show {
            display: block;
        }

        .result-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .result-score {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .result-message {
            font-size: 1.2rem;
            color: #aaa;
            margin: 15px 0;
        }

        .result-breakdown {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .breakdown-item {
            text-align: center;
        }

        .breakdown-number {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .breakdown-label {
            color: #888;
            font-size: 0.85rem;
        }

        .restart-btn {
            padding: 15px 40px;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            border: none;
            border-radius: 25px;
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .restart-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 210, 255, 0.3);
        }

        .start-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .start-btn {
            padding: 18px 50px;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            border: none;
            border-radius: 25px;
            color: #fff;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 25px;
        }

        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 210, 255, 0.3);
        }

        .start-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .question-count-section {
            margin: 20px 0;
            text-align: center;
        }

        .question-count-label {
            color: #aaa;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .question-count-input {
            width: 80px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            text-align: center;
        }

        .question-count-input:focus {
            outline: none;
            border-color: #3a7bd5;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #888;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #00d2ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 600px) {
            h1 { font-size: 1.6rem; }
            .question-text { font-size: 1rem; }
            .stats-bar { gap: 10px; }
            .stat-item { padding: 10px 15px; }
            .category-label { padding: 6px 12px; font-size: 0.8rem; }
        }

        /* Algorithm Info */
        .algorithm-info {
            margin-top: 15px;
            padding: 10px;
            background: rgba(58, 123, 213, 0.1);
            border-radius: 8px;
            font-size: 0.8rem;
            color: #888;
            text-align: center;
        }

        .algorithm-info strong {
            color: #00d2ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>CS 면접 주관식 퀴즈</h1>
            <p class="subtitle">백엔드 개발자를 위한 기술 면접 대비</p>
        </header>

        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-number" id="totalQuestions">0</div>
                <div class="stat-label">선택된 문제</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="avgScore">0%</div>
                <div class="stat-label">평균 점수</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="answeredCount">0</div>
                <div class="stat-label">답변 완료</div>
            </div>
        </div>

        <!-- 로딩 화면 -->
        <div class="quiz-container loading" id="loadingScreen">
            <div class="loading-spinner"></div>
            <p>문제를 불러오는 중...</p>
        </div>

        <!-- 시작 화면 -->
        <div class="quiz-container start-screen" id="startScreen" style="display: none;">
            <h2>카테고리를 선택하세요</h2>
            <p style="color: #888; margin-top: 10px;">여러 카테고리를 선택하면 섞어서 출제됩니다</p>

            <div id="categoryContainer"></div>

            <div class="select-buttons">
                <button class="select-btn" onclick="selectAll()">전체 선택</button>
                <button class="select-btn" onclick="deselectAll()">전체 해제</button>
            </div>

            <div class="question-count-section">
                <div class="question-count-label">출제할 문제 수</div>
                <input type="number" class="question-count-input" id="questionCountInput" value="10" min="1" max="50">
            </div>

            <button class="start-btn" id="startBtn" onclick="startQuiz()">퀴즈 시작하기</button>

            <div class="algorithm-info">
                채점 알고리즘: <strong>TF-IDF 코사인 유사도</strong> + 키워드 매칭
            </div>
        </div>

        <!-- 퀴즈 화면 -->
        <div class="quiz-container" id="quizScreen" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>

            <div class="question-header">
                <span class="question-number" id="questionNumber">문제 1 / 10</span>
                <span class="question-id" id="questionId">NET-001</span>
                <span class="question-category" id="questionCategory">Database</span>
            </div>

            <div class="question-text" id="questionText">
                질문이 여기에 표시됩니다.
            </div>

            <div class="answer-section">
                <textarea class="answer-textarea" id="answerInput" placeholder="답변을 입력하세요..."></textarea>
            </div>

            <button class="submit-btn" id="submitBtn" onclick="submitAnswer()">답변 제출</button>

            <div class="feedback-container" id="feedbackContainer">
                <div class="feedback-header">
                    <span class="feedback-icon" id="feedbackIcon"></span>
                    <span class="feedback-score" id="feedbackScore"></span>
                </div>

                <div class="similarity-details" id="similarityDetails">
                    <div class="similarity-item">
                        <span>TF-IDF 코사인 유사도</span>
                        <span id="cosineSimilarity">0%</span>
                    </div>
                    <div class="similarity-item">
                        <span>키워드 매칭률</span>
                        <span id="keywordMatch">0%</span>
                    </div>
                    <div class="similarity-item">
                        <span>답변 길이 보너스</span>
                        <span id="lengthBonus">0%</span>
                    </div>
                </div>

                <div class="keywords-section">
                    <div class="keywords-title">핵심 키워드 매칭</div>
                    <div class="keywords-list" id="keywordsList"></div>
                </div>

                <div class="model-answer">
                    <div class="model-answer-title">모범 답안</div>
                    <div class="model-answer-text" id="modelAnswer"></div>
                    <div class="references" id="references"></div>
                </div>
            </div>

            <div class="nav-buttons">
                <button class="nav-btn prev" id="prevBtn" onclick="prevQuestion()" disabled>이전</button>
                <button class="nav-btn next" id="nextBtn" onclick="nextQuestion()" disabled>다음</button>
            </div>
        </div>

        <!-- 결과 화면 -->
        <div class="quiz-container result-container" id="resultScreen">
            <div class="result-icon" id="resultIcon"></div>
            <div class="result-score" id="resultScore">85%</div>
            <div class="result-message" id="resultMessage"></div>
            <div class="result-breakdown">
                <div class="breakdown-item">
                    <div class="breakdown-number" id="excellentCount" style="color: #00c853;">0</div>
                    <div class="breakdown-label">우수 (80%+)</div>
                </div>
                <div class="breakdown-item">
                    <div class="breakdown-number" id="goodCount" style="color: #00d2ff;">0</div>
                    <div class="breakdown-label">양호 (60-79%)</div>
                </div>
                <div class="breakdown-item">
                    <div class="breakdown-number" id="partialCount" style="color: #ffc107;">0</div>
                    <div class="breakdown-label">부분 (40-59%)</div>
                </div>
                <div class="breakdown-item">
                    <div class="breakdown-number" id="needsWorkCount" style="color: #ff5252;">0</div>
                    <div class="breakdown-label">복습필요 (0-39%)</div>
                </div>
            </div>
            <button class="restart-btn" onclick="restartQuiz()">다시 풀기</button>
        </div>
    </div>

    <script src="quizData.js"></script>
    <script>
        // ================================
        // TF-IDF 코사인 유사도 알고리즘
        // ================================

        class TFIDFSimilarity {
            constructor() {
                this.stopwords = new Set([
                    // 한국어 불용어
                    '이', '그', '저', '것', '수', '등', '및', '또는', '그리고', '하지만',
                    '따라서', '위해', '통해', '대해', '경우', '때문에', '있습니다', '합니다',
                    '됩니다', '입니다', '있는', '하는', '되는', '있다', '한다', '된다',
                    '그것', '이것', '저것', '무엇', '어떤', '모든', '각', '다른',
                    // 영어 불용어
                    'the', 'a', 'an', 'is', 'are', 'was', 'were', 'be', 'been', 'being',
                    'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could',
                    'should', 'may', 'might', 'must', 'can', 'to', 'of', 'in', 'for',
                    'on', 'with', 'at', 'by', 'from', 'as', 'into', 'through', 'and',
                    'but', 'or', 'not', 'this', 'that', 'these', 'those', 'it', 'its'
                ]);
            }

            // 텍스트 토큰화
            tokenize(text) {
                const normalized = text.toLowerCase()
                    .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();

                return normalized.split(' ')
                    .filter(word => word.length > 1 && !this.stopwords.has(word));
            }

            // TF (Term Frequency) 계산
            computeTF(tokens) {
                const tf = {};
                const total = tokens.length;

                for (const token of tokens) {
                    tf[token] = (tf[token] || 0) + 1;
                }

                // 정규화
                for (const token in tf) {
                    tf[token] = tf[token] / total;
                }

                return tf;
            }

            // IDF (Inverse Document Frequency) 계산
            computeIDF(documents) {
                const idf = {};
                const N = documents.length;

                // 각 단어가 등장하는 문서 수 계산
                const docFreq = {};
                for (const doc of documents) {
                    const uniqueTokens = new Set(doc);
                    for (const token of uniqueTokens) {
                        docFreq[token] = (docFreq[token] || 0) + 1;
                    }
                }

                // IDF 계산: log(N / df)
                for (const token in docFreq) {
                    idf[token] = Math.log(N / docFreq[token]) + 1;
                }

                return idf;
            }

            // TF-IDF 벡터 생성
            computeTFIDF(tf, idf) {
                const tfidf = {};
                for (const token in tf) {
                    tfidf[token] = tf[token] * (idf[token] || 1);
                }
                return tfidf;
            }

            // 코사인 유사도 계산
            cosineSimilarity(vec1, vec2) {
                const allKeys = new Set([...Object.keys(vec1), ...Object.keys(vec2)]);

                let dotProduct = 0;
                let magnitude1 = 0;
                let magnitude2 = 0;

                for (const key of allKeys) {
                    const v1 = vec1[key] || 0;
                    const v2 = vec2[key] || 0;
                    dotProduct += v1 * v2;
                    magnitude1 += v1 * v1;
                    magnitude2 += v2 * v2;
                }

                magnitude1 = Math.sqrt(magnitude1);
                magnitude2 = Math.sqrt(magnitude2);

                if (magnitude1 === 0 || magnitude2 === 0) return 0;

                return dotProduct / (magnitude1 * magnitude2);
            }

            // 두 텍스트 간 유사도 계산
            calculateSimilarity(text1, text2) {
                const tokens1 = this.tokenize(text1);
                const tokens2 = this.tokenize(text2);

                if (tokens1.length === 0 || tokens2.length === 0) {
                    return 0;
                }

                // IDF는 두 문서를 기준으로 계산
                const idf = this.computeIDF([tokens1, tokens2]);

                const tf1 = this.computeTF(tokens1);
                const tf2 = this.computeTF(tokens2);

                const tfidf1 = this.computeTFIDF(tf1, idf);
                const tfidf2 = this.computeTFIDF(tf2, idf);

                return this.cosineSimilarity(tfidf1, tfidf2);
            }
        }

        // ================================
        // 퀴즈 로직
        // ================================

        const tfidf = new TFIDFSimilarity();

        let currentQuiz = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let scores = [];
        let categoryGroups = {};

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initializeCategories();
        });

        // 카테고리 초기화
        function initializeCategories() {
            // 우선순위별 그룹화
            const priorities = {
                'P1': { title: 'P1 핵심 - CS 기초 & Framework', color: '#ff6b6b', categories: [] },
                'P2': { title: 'P2 중요 - 인프라 & 메시징', color: '#ffa502', categories: [] },
                'P3': { title: 'P3 부가 - 심화 기술', color: '#1e90ff', categories: [] },
                'P4': { title: 'P4 추가 - 기타', color: '#2ed573', categories: [] }
            };

            // 카테고리 그룹화
            const categoryMap = {};
            for (const q of quizData) {
                if (!categoryMap[q.category]) {
                    categoryMap[q.category] = {
                        id: q.category,
                        name: q.categoryName,
                        priority: q.priority || 'P4',
                        count: 0
                    };
                }
                categoryMap[q.category].count++;
            }

            for (const cat of Object.values(categoryMap)) {
                const priority = priorities[cat.priority] || priorities['P4'];
                priority.categories.push(cat);
            }

            // HTML 생성
            const container = document.getElementById('categoryContainer');
            let html = '';

            for (const [key, group] of Object.entries(priorities)) {
                if (group.categories.length === 0) continue;

                html += `
                    <div class="category-section">
                        <h3 style="color: ${group.color};">${group.title}</h3>
                        <div class="category-grid">
                `;

                for (const cat of group.categories) {
                    const checked = key === 'P1' ? 'checked' : '';
                    html += `
                        <input type="checkbox" class="category-checkbox" id="cat-${cat.id}" value="${cat.id}" ${checked}>
                        <label class="category-label" for="cat-${cat.id}">${cat.name} (${cat.count})</label>
                    `;
                }

                html += `
                        </div>
                        <div class="select-buttons" style="margin-top: 8px;">
                            <button class="select-btn" onclick="selectPriority('${key}')">전체 선택</button>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;

            // 체크박스 이벤트 리스너
            document.querySelectorAll('.category-checkbox').forEach(cb => {
                cb.addEventListener('change', updateQuestionCount);
            });

            // 로딩 완료
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'block';
            updateQuestionCount();
        }

        function updateQuestionCount() {
            const selected = getSelectedCategories();
            const available = quizData.filter(q => selected.includes(q.category)).length;
            document.getElementById('totalQuestions').textContent = available;

            const input = document.getElementById('questionCountInput');
            if (parseInt(input.value) > available) {
                input.value = Math.min(available, 50);
            }
            input.max = Math.min(available, 100);

            document.getElementById('startBtn').disabled = available === 0;
        }

        function getSelectedCategories() {
            const checkboxes = document.querySelectorAll('.category-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function selectAll() {
            document.querySelectorAll('.category-checkbox').forEach(cb => cb.checked = true);
            updateQuestionCount();
        }

        function deselectAll() {
            document.querySelectorAll('.category-checkbox').forEach(cb => cb.checked = false);
            updateQuestionCount();
        }

        function selectPriority(priority) {
            const categories = quizData
                .filter(q => q.priority === priority)
                .map(q => q.category);

            const uniqueCategories = [...new Set(categories)];

            for (const cat of uniqueCategories) {
                const cb = document.getElementById('cat-' + cat);
                if (cb) cb.checked = true;
            }
            updateQuestionCount();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function startQuiz() {
            const selected = getSelectedCategories();
            const questionCount = parseInt(document.getElementById('questionCountInput').value);

            let filteredQuestions = quizData.filter(q => selected.includes(q.category));
            shuffleArray(filteredQuestions);

            currentQuiz = filteredQuestions.slice(0, Math.min(questionCount, filteredQuestions.length));
            currentQuestionIndex = 0;
            userAnswers = new Array(currentQuiz.length).fill('');
            scores = new Array(currentQuiz.length).fill(null);

            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('quizScreen').style.display = 'block';
            document.getElementById('resultScreen').classList.remove('show');

            updateStats();
            showQuestion();
        }

        function showQuestion() {
            const question = currentQuiz[currentQuestionIndex];

            const progress = ((currentQuestionIndex) / currentQuiz.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';

            document.getElementById('questionNumber').textContent =
                `문제 ${currentQuestionIndex + 1} / ${currentQuiz.length}`;
            document.getElementById('questionId').textContent = question.id;
            document.getElementById('questionCategory').textContent = question.categoryName;
            document.getElementById('questionText').textContent = question.question;

            document.getElementById('answerInput').value = userAnswers[currentQuestionIndex];

            const feedbackContainer = document.getElementById('feedbackContainer');
            if (scores[currentQuestionIndex] !== null) {
                showFeedback(currentQuestionIndex);
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('answerInput').disabled = true;
            } else {
                feedbackContainer.classList.remove('show');
                feedbackContainer.className = 'feedback-container';
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('answerInput').disabled = false;
            }

            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextBtn').disabled = scores[currentQuestionIndex] === null;
            document.getElementById('nextBtn').textContent =
                currentQuestionIndex === currentQuiz.length - 1 ? '결과 보기' : '다음';
        }

        // 종합 유사도 계산
        function calculateSimilarity(userAnswer, question) {
            const modelAnswer = question.answer;
            const keywords = question.keywords || [];

            // 1. TF-IDF 코사인 유사도 (40%)
            const cosineSim = tfidf.calculateSimilarity(userAnswer, modelAnswer);
            const cosineScore = cosineSim * 100;

            // 2. 키워드 매칭 (40%)
            const normalizedAnswer = userAnswer.toLowerCase();
            let matchedKeywords = [];
            let missedKeywords = [];

            for (const keyword of keywords) {
                const keywordLower = keyword.toLowerCase();
                if (normalizedAnswer.includes(keywordLower)) {
                    matchedKeywords.push(keyword);
                } else {
                    missedKeywords.push(keyword);
                }
            }

            const keywordScore = keywords.length > 0
                ? (matchedKeywords.length / keywords.length) * 100
                : 50;

            // 3. 답변 길이 보너스 (20%)
            const idealLength = modelAnswer.length * 0.5;
            const lengthRatio = Math.min(userAnswer.length / idealLength, 1.5);
            const lengthScore = Math.min(lengthRatio * 66.7, 100);

            // 최종 점수 계산
            const totalScore = Math.round(
                cosineScore * 0.4 +
                keywordScore * 0.4 +
                lengthScore * 0.2
            );

            return {
                score: Math.min(100, totalScore),
                cosineScore: Math.round(cosineScore),
                keywordScore: Math.round(keywordScore),
                lengthScore: Math.round(lengthScore),
                matchedKeywords,
                missedKeywords
            };
        }

        function submitAnswer() {
            const userAnswer = document.getElementById('answerInput').value.trim();

            if (userAnswer.length < 10) {
                alert('답변을 좀 더 자세히 작성해 주세요. (최소 10자 이상)');
                return;
            }

            userAnswers[currentQuestionIndex] = userAnswer;

            const question = currentQuiz[currentQuestionIndex];
            const result = calculateSimilarity(userAnswer, question);
            scores[currentQuestionIndex] = result;

            showFeedback(currentQuestionIndex);
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('answerInput').disabled = true;
            document.getElementById('nextBtn').disabled = false;

            updateStats();
        }

        function showFeedback(index) {
            const question = currentQuiz[index];
            const result = scores[index];
            const feedbackContainer = document.getElementById('feedbackContainer');

            feedbackContainer.className = 'feedback-container show';
            let icon, scoreClass, message;

            if (result.score >= 80) {
                feedbackContainer.classList.add('feedback-excellent');
                icon = '!';
                scoreClass = 'excellent';
                message = '우수한 답변입니다!';
            } else if (result.score >= 60) {
                feedbackContainer.classList.add('feedback-good');
                icon = '+';
                scoreClass = 'good';
                message = '좋습니다! 몇 가지 키워드를 더 언급하면 좋겠습니다.';
            } else if (result.score >= 40) {
                feedbackContainer.classList.add('feedback-partial');
                icon = '*';
                scoreClass = 'partial';
                message = '부분적으로 맞았습니다. 모범 답안을 참고하세요.';
            } else {
                feedbackContainer.classList.add('feedback-needs-work');
                icon = '?';
                scoreClass = 'needs-work';
                message = '더 학습이 필요합니다. 모범 답안을 꼼꼼히 읽어보세요.';
            }

            document.getElementById('feedbackIcon').textContent = icon;
            document.getElementById('feedbackScore').textContent = `${result.score}점 - ${message}`;
            document.getElementById('feedbackScore').className = `feedback-score ${scoreClass}`;

            // 유사도 상세
            document.getElementById('cosineSimilarity').textContent = `${result.cosineScore}%`;
            document.getElementById('keywordMatch').textContent = `${result.keywordScore}%`;
            document.getElementById('lengthBonus').textContent = `${result.lengthScore}%`;

            // 키워드 표시
            const keywordsList = document.getElementById('keywordsList');
            keywordsList.innerHTML = '';

            result.matchedKeywords.forEach(kw => {
                const span = document.createElement('span');
                span.className = 'keyword matched';
                span.textContent = kw;
                keywordsList.appendChild(span);
            });

            result.missedKeywords.slice(0, 10).forEach(kw => {
                const span = document.createElement('span');
                span.className = 'keyword missed';
                span.textContent = kw;
                keywordsList.appendChild(span);
            });

            // 모범 답안
            document.getElementById('modelAnswer').textContent = question.answer;

            // 참고자료
            const refsContainer = document.getElementById('references');
            if (question.references && question.references.length > 0) {
                let refsHtml = '<div class="references-title">참고자료</div>';
                for (const ref of question.references) {
                    refsHtml += `<a href="${ref.url}" target="_blank">${ref.title}</a>`;
                }
                refsContainer.innerHTML = refsHtml;
                refsContainer.style.display = 'block';
            } else {
                refsContainer.style.display = 'none';
            }
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion();
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < currentQuiz.length - 1) {
                currentQuestionIndex++;
                showQuestion();
            } else {
                showResults();
            }
        }

        function updateStats() {
            const answered = scores.filter(s => s !== null).length;
            const totalScore = scores.filter(s => s !== null).reduce((sum, s) => sum + s.score, 0);
            const avg = answered > 0 ? Math.round(totalScore / answered) : 0;

            document.getElementById('answeredCount').textContent = answered;
            document.getElementById('avgScore').textContent = avg + '%';
        }

        function showResults() {
            document.getElementById('quizScreen').style.display = 'none';
            document.getElementById('resultScreen').classList.add('show');

            const totalScore = scores.reduce((sum, s) => sum + s.score, 0);
            const avg = Math.round(totalScore / scores.length);

            let excellent = 0, good = 0, partial = 0, needsWork = 0;
            for (const s of scores) {
                if (s.score >= 80) excellent++;
                else if (s.score >= 60) good++;
                else if (s.score >= 40) partial++;
                else needsWork++;
            }

            let icon, message;
            if (avg >= 80) {
                icon = '!';
                message = '훌륭합니다! 면접 준비가 잘 되어있습니다.';
            } else if (avg >= 60) {
                icon = '+';
                message = '좋습니다! 조금만 더 보완하면 완벽해집니다.';
            } else if (avg >= 40) {
                icon = '*';
                message = '기본은 잡았습니다. 복습이 필요한 부분을 확인하세요.';
            } else {
                icon = '?';
                message = '더 많은 학습이 필요합니다. 모범 답안을 참고하여 복습하세요.';
            }

            document.getElementById('resultIcon').textContent = icon;
            document.getElementById('resultScore').textContent = avg + '%';
            document.getElementById('resultMessage').textContent = message;
            document.getElementById('excellentCount').textContent = excellent;
            document.getElementById('goodCount').textContent = good;
            document.getElementById('partialCount').textContent = partial;
            document.getElementById('needsWorkCount').textContent = needsWork;
        }

        function restartQuiz() {
            document.getElementById('resultScreen').classList.remove('show');
            document.getElementById('startScreen').style.display = 'block';
            updateQuestionCount();
        }
    </script>
</body>
</html>
